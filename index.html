<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Enforce Trusted Types for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="object-src 'none'; base-uri 'none'; require-trusted-types-for 'script';" />
    <title>Singularity Canvas</title>
    <style>
        :root {
            --panel-bg: rgba(255, 255, 255, 0.3); --panel-text: #2c3e50; --control-bg: rgba(255, 255, 255, 0.7);
            --summary-hover: rgba(0,0,0,0.05); --border-color: rgba(0,0,0,0.1); --button-text: #fff;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .background-base { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; transition: background 0.8s ease; }
        .gradient-bg .background-base { background-size: 400% 400%; animation: gradient-animation 15s ease infinite; }
        .dark-bg .background-base { background-color: #1a1a1a; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #tsparticles { position: absolute; width: 100%; height: 100%; z-index: 1; cursor: default; }
        #tsparticles.drawing-mode { cursor: crosshair; }
        .info-overlay { position: fixed; top: 10px; left: 10px; z-index: 100; font-family: monospace; }
        .info-overlay .label { padding: 5px 10px; background: rgba(0,0,0,0.5); color: #0f0; border-radius: 5px; }
        .controls-panel {
            position: absolute; bottom: 20px; right: 20px; background-color: var(--panel-bg); backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px); border-radius: 15px; padding: 20px; z-index: 10; color: var(--panel-text);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); width: 320px; max-height: calc(100vh - 40px);
            overflow-y: auto; transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .controls-panel.hidden { transform: translateX(calc(100% + 40px)); opacity: 0; }
        .controls-panel.dark-mode { --panel-bg: rgba(25, 25, 25, 0.6); --panel-text: #ecf0f1; --control-bg: rgba(50, 50, 50, 0.8); --summary-hover: rgba(255,255,255,0.1); --border-color: rgba(255,255,255,0.2); --button-text: #fff; }
        details { margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        details > summary { font-weight: 600; cursor: pointer; padding: 8px; border-radius: 5px; transition: background-color 0.2s; }
        .control-group { padding: 10px 5px 0 5px; }
        .control-group label { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 500; }
        .controls-panel input, .controls-panel select, .controls-panel button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--control-bg); box-sizing: border-box; cursor: pointer; font-size: 14px; color: var(--panel-text); margin-top: 5px; }
        .controls-panel input[type="range"] { padding: 0; height: 20px; }
        .controls-panel input[type="color"] { padding: 2px; height: 35px; }
        .controls-panel input[type="checkbox"] { width: auto; }
        .controls-panel button { background: linear-gradient(45deg, #8e44ad, #3498db); color: var(--button-text); font-weight: bold; border: none; }
        .toggle-button {
            position: fixed; bottom: 20px; right: -30px; width: 30px; height: 100px; background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 10px 0 0 10px; cursor: pointer; writing-mode: vertical-rl;
            display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #333;
            z-index: 9; transition: right 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .controls-panel.hidden + .toggle-button { right: 0; }
    </style>
</head>
<body>
    <div class="background-base"></div>
    <div id="tsparticles"></div>
    <div class="info-overlay"><span class="label" id="fps">FPS: --</span></div>

    <div class="controls-panel" id="controls">
        <h3>Singularity Canvas</h3>
        <div class="control-group"><label>UI Theme<input type="checkbox" id="dark-mode-toggle"></label></div>

        <details>
            <summary>Presets</summary>
            <div class="control-group"><label for="preset-select">Built-in Presets</label><select id="preset-select"></select></div>
            <div class="control-group"><label for="import-preset-input">Import/Export</label><button id="export-preset-btn">Export JSON</button><input type="file" id="import-preset-input" accept=".json" style="display:none;"><button onclick="document.getElementById('import-preset-input').click();">Import JSON</button></div>
        </details>

        <details open>
            <summary>Appearance</summary>
            <div class="control-group"><label for="particle-count">Count <span id="particle-count-value"></span></label><input type="range" id="particle-count" min="10" max="2000" value="150"></div>
            <div class="control-group"><label for="particle-size">Size <span id="particle-size-value"></span></label><input type="range" id="particle-size" min="0.1" max="50" step="0.1" value="2"></div>
            <div class="control-group"><label for="particle-color">Particle Color</label><input type="color" id="particle-color" value="#ffffff"></div>
            <div class="control-group"><label for="link-color">Link Color</label><input type="color" id="link-color" value="#ffffff"></div>
        </details>

        <details>
            <summary>Movement & Physics</summary>
            <div class="control-group"><label for="particle-speed">Speed <span id="particle-speed-value"></span></label><input type="range" id="particle-speed" min="0" max="50" step="0.1" value="1.5"></div>
            <div class="control-group"><label for="link-distance">Link Distance <span id="link-distance-value"></span></label><input type="range" id="link-distance" min="0" max="500" value="150"></div>
             <div class="control-group"><label for="fps-limit">FPS Limit <span id="fps-limit-value"></span></label><input type="range" id="fps-limit" min="15" max="144" value="60"></div>
        </details>
        
        <details>
            <summary>Text & Paths</summary>
            <div class="control-group"><label for="text-input">Display Text</label><input type="text" id="text-input" placeholder="Type words here..."><button id="apply-text-btn">Morph Particles</button></div>
            <div class="control-group"><label>Custom Path</label><button id="draw-path-btn">Start Drawing</button><button id="clear-path-btn">Clear Path</button></div>
        </details>
    </div>
    <div class="toggle-button" id="toggle-controls">CONTROLS</div>

    <script src="https://cdn.jsdelivr.net/npm/tsparticles-all@2.12.0/tsparticles.all.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let particlesContainer;
            
            const ui = {
                body: document.body,
                controlsPanel: document.getElementById('controls'),
                backgroundBase: document.querySelector('.background-base'),
                fps: document.getElementById('fps'),
                particlesCanvas: document.getElementById('tsparticles'),
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                presetSelect: document.getElementById('preset-select'),
                exportPresetBtn: document.getElementById('export-preset-btn'),
                importPresetInput: document.getElementById('import-preset-input'),
                particleCount: { slider: document.getElementById('particle-count'), value: document.getElementById('particle-count-value') },
                particleSize: { slider: document.getElementById('particle-size'), value: document.getElementById('particle-size-value') },
                particleSpeed: { slider: document.getElementById('particle-speed'), value: document.getElementById('particle-speed-value') },
                linkColor: document.getElementById('link-color'),
                particleColor: document.getElementById('particle-color'),
                linkDistance: { slider: document.getElementById('link-distance'), value: document.getElementById('link-distance-value') },
                fpsLimit: { slider: document.getElementById('fps-limit'), value: document.getElementById('fps-limit-value') },
                textInput: document.getElementById('text-input'),
                applyTextBtn: document.getElementById('apply-text-btn'),
                drawPathBtn: document.getElementById('draw-path-btn'),
                clearPathBtn: document.getElementById('clear-path-btn'),
                toggleControlsBtn: document.getElementById('toggle-controls')
            };

            const basePresets = {
                default: { options: { fpsLimit: 60, particles: { number: { value: 150 }, color: { value: "#ffffff" }, shape: { type: "circle" }, opacity: { value: 0.5 }, size: { value: 2 }, links: { enable: true, color: {value: "#ffffff"}, distance: 150, width: 1 }, move: { enable: true, speed: 1.5 } }, interactivity: { events: { onhover: { enable: true, mode: "grab" }, onclick: { enable: true, mode: "push" } } } }, backgroundClass: 'gradient-bg' },
                starfield: { options: { fpsLimit: 60, particles: { number: { value: 800 }, color: { value: "#ffffff" }, shape: { type: "circle" }, opacity: { value: { min: 0.1, max: 0.7 } }, size: { value: { min: 0.5, max: 2.5 } }, links: {enable: false}, move: { enable: true, speed: 0.4, direction: "none", straight: true } }, interactivity: { events: { onhover: { enable: true, mode: "bubble" } } } }, backgroundClass: 'dark-bg' },
                textMorph: { options: { fpsLimit: 60, particles: { number: { value: 1000, density: { enable: true } }, color: { value: "#ffffff" }, opacity: { value: 0.8 }, size: { value: 1.5 }, links: {enable: false}, move: { enable: true, speed: 2, attract: { enable: true } } }, interactivity: { events: { onhover: { enable: true, mode: "repulse" } } } }, backgroundClass: 'dark-bg' },
            };

            const updateParticles = (options) => { if (particlesContainer) particlesContainer.options.load(options); };

            const loadPresets = () => {
                while (ui.presetSelect.firstChild) ui.presetSelect.removeChild(ui.presetSelect.firstChild);
                Object.keys(basePresets).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name; option.textContent = name;
                    ui.presetSelect.appendChild(option);
                });
                return basePresets;
            };
            
            const exportPreset = () => {
                if (!particlesContainer) return;
                const config = { options: particlesContainer.options.exportJSON(), backgroundClass: ui.body.className };
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${ui.presetSelect.value || 'custom'}_preset.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const importPreset = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const config = JSON.parse(e.target.result);
                        if (config.options) {
                            if (particlesContainer) particlesContainer.destroy();
                            particlesContainer = await tsParticles.load("tsparticles", config.options);
                            ui.body.className = config.backgroundClass || 'dark-bg';
                            syncUiToState();
                        }
                    } catch (error) { alert('Invalid preset file.'); }
                };
                reader.readAsText(file);
                ui.importPresetInput.value = "";
            };

            const applyPreset = async (name) => {
                const presets = loadPresets();
                const preset = presets[name] || presets.default;
                if (particlesContainer) particlesContainer.destroy();
                particlesContainer = await tsParticles.load("tsparticles", preset.options);
                ui.body.className = preset.backgroundClass;
                if (preset.backgroundClass === 'gradient-bg') setRandomGradient();
                syncUiToState();
            };

            const syncUiToState = () => {
                if (!particlesContainer) return;
                const opts = particlesContainer.options;
                const updateSlider = (uiElement, value) => { uiElement.slider.value = value; uiElement.value.textContent = value; };
                updateSlider(ui.particleCount, opts.particles.number.value);
                updateSlider(ui.particleSize, opts.particles.size.value);
                updateSlider(ui.particleSpeed, opts.particles.move.speed);
                updateSlider(ui.linkDistance, opts.particles.links.distance);
                updateSlider(ui.fpsLimit, opts.fpsLimit);
                ui.particleColor.value = opts.particles.color.value;
                const linkColor = opts.particles.links.color?.value;
                if(typeof linkColor === 'string') ui.linkColor.value = linkColor;
            };

            const bindUI = () => {
                ui.darkModeToggle.addEventListener('change', (e) => ui.controlsPanel.classList.toggle('dark-mode', e.target.checked));
                ui.toggleControlsBtn.addEventListener('click', () => ui.controlsPanel.classList.toggle('hidden'));
                ui.presetSelect.addEventListener('change', (e) => applyPreset(e.target.value));
                ui.exportPresetBtn.addEventListener('click', exportPreset);
                ui.importPresetInput.addEventListener('change', importPreset);

                const addSliderListener = (uiElement, updater) => {
                    uiElement.slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        uiElement.value.textContent = value;
                        updater(value);
                    });
                };
                addSliderListener(ui.particleCount, (v) => updateParticles({ particles: { number: { value: v } } }));
                addSliderListener(ui.particleSize, (v) => updateParticles({ particles: { size: { value: v } } }));
                addSliderListener(ui.particleSpeed, (v) => updateParticles({ particles: { move: { speed: v } } }));
                addSliderListener(ui.linkDistance, (v) => updateParticles({ particles: { links: { distance: v } } }));
                addSliderListener(ui.fpsLimit, (v) => updateParticles({ fpsLimit: v }));
                
                ui.particleColor.addEventListener('input', (e) => updateParticles({ particles: { color: { value: e.target.value } } }));
                ui.linkColor.addEventListener('input', (e) => updateParticles({ particles: { links: { color: { value: e.target.value } } } }));

                ui.applyTextBtn.addEventListener('click', async () => {
                    if (ui.presetSelect.value !== 'textMorph') { await applyPreset('textMorph'); ui.presetSelect.value = 'textMorph'; }
                    particlesContainer.plugins.get("text")?.draw({ value: ui.textInput.value || "Singularity", font: "bold 36px 'Segoe UI', sans-serif" });
                });

                ui.drawPathBtn.addEventListener('click', () => { isDrawing = true; ui.particlesCanvas.classList.add('drawing-mode'); });
                ui.clearPathBtn.addEventListener('click', () => { pathPoints = []; updateParticles({ particles: { move: { path: { enable: false } } } }); });
            };
            
            const setRandomGradient = () => ui.backgroundBase.style.backgroundImage = `linear-gradient(${Math.random() * 360}deg, hsl(${Math.random() * 360}, 90%, 65%), hsl(${Math.random() * 360}, 90%, 65%))`;
            const setupFpsCounter = () => { const times = []; requestAnimationFrame(function loop() { const now = performance.now(); while (times.length > 0 && times[0] <= now - 1000) { times.shift(); } times.push(now); ui.fps.textContent = `FPS: ${times.length}`; requestAnimationFrame(loop); }); };

            let isDrawing = false, pathPoints = [];
            const setupPathDrawing = () => {
                const canvas = ui.particlesCanvas;
                const start = (e) => { if (!isDrawing) return; pathPoints = [{ x: e.offsetX, y: e.offsetY }]; canvas.addEventListener('mousemove', move); };
                const move = (e) => { pathPoints.push({ x: e.offsetX, y: e.offsetY }); };
                const stop = () => { if (!isDrawing) return; canvas.removeEventListener('mousemove', move); if (pathPoints.length > 1) { updateParticles({ particles: { move: { path: { enable: true, path: pathPoints } } } }); } isDrawing = false; ui.particlesCanvas.classList.remove('drawing-mode'); };
                canvas.addEventListener('mousedown', start);
                canvas.addEventListener('mouseup', stop);
                canvas.addEventListener('mouseleave', stop);
            };

            setupFpsCounter();
            bindUI();
            setupPathDrawing();
            await applyPreset('default');
        });
    </script>
</body>
</html>
