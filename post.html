<body>
    <iframe id="target" src="https://ndevtk.github.io/cross-site/"></iframe>
    <iframe id="checker" src="https://ndevtk.github.io/cross-site/"></iframe>
    <script>
      let target = document.getElementById('target');
      let checker = document.getElementById('checker');
       
      async function check(value, attempts = 100000) {
        let attempt = 1000000;
        let knownbad = 1000000;
        for(let i=5; i--;) {
            let result = await time(value, attempts);
            if (result < attempt) attempt = result;
        }
        for(let i=5; i--;) {
            let result = await time(value, attempts);
            if (knownbad < attempt) knownbad = result;
        }
        return attempt - knownbad;
      }

      function time(value, attempts) {
        return new Promise(resolve => {
          checker.onload = () => {
            resolve(performance.now() - start);
            target.contentWindow.location = "https://ndevtk.github.io/cross-site/";
          };
          for(let i=attempts; i--;) target.contentWindow.postMessage(value, '*');
          let start = performance.now();
          checker.contentWindow.location = "https://ndevtk.github.io/cross-site/";
        });
      }
    </script>
</body>
